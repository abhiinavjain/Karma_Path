<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Karma Path: Mahabharata Event Visualizer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Noto+Serif:wght@400;700&display=swap" rel="stylesheet">
    <style>
        /* Custom Fonts */
        body { font-family: 'Noto Serif', serif; } /* For body text, more readable */
        h1, h2, h3, .font-cinzel { font-family: 'Cinzel', serif; } /* For headings, more epic/regal */

        /* Thematic Background with subtle pattern */
        body {
            background-color: #f7ede2; /* A warm, parchment-like base */
            background-image: url("data:image/svg+xml,%3Csvg width='60' height='60' viewBox='0 0 60 60' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23e0d8cc' fill-opacity='0.4'%3E%3Cpath d='M30 15c0 5.523 4.477 10 10 10 0 5.523 4.477 10 10 10s10-4.477 10-10-4.477-10-10-10c0-5.523-4.477-10-10-10S30 4.477 30 10c0 5.523-4.477 10-10 10-5.523 0-10 4.477-10 10s4.477 10 10 10c0 5.523 4.477 10 10 10s10-4.477 10-10c0-5.523-4.477-10-10-10C34.477 25 30 20.523 30 15z'/%3E%3C/g%3E%3C/svg%3E");
        }

        /* Loader Animation */
        .loader {
            border: 4px solid rgba(255, 255, 255, 0.3);
            border-top: 4px solid #b74f00; /* Deep gold/ochre */
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Mermaid Styles */
        .mermaid { display: flex; justify-content: center; }
        .mermaid svg { max-width: 100%; height: auto; }

        /* Custom Choice Button Styles */
        .choice-button {
            display: block; width: 100%; text-align: left;
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border: 1px solid #c9b19e; /* Muted border */
            border-radius: 0.375rem; /* Slightly smaller radius */
            background-color: #fcf6e8; /* Lighter parchment */
            color: #5a4b3f; /* Darker text */
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); /* Subtle shadow */
        }
        .choice-button:hover {
            background-color: #f0ead6; /* Slightly darker on hover */
            border-color: #a08c78; /* More prominent border on hover */
            color: #4a3e33;
        }
        .choice-button strong { color: #8d4f01; font-family: 'Cinzel', serif; } /* Highlight ID */
        .choice-button i { color: #7a6a5a; font-size: 0.9em; } /* Score text */

        /* Thematic Scrollbar (Optional, for modern browsers) */
        ::-webkit-scrollbar { width: 10px; height: 10px; }
        ::-webkit-scrollbar-track { background: #f7ede2; border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background: #b74f00; border-radius: 10px; border: 2px solid #f7ede2; }
        ::-webkit-scrollbar-thumb:hover { background: #8d4f01; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">
    <div class="max-w-7xl mx-auto bg-white rounded-xl shadow-2xl p-6 md:p-10 border border-gray-200"> <div class="flex flex-col sm:flex-row justify-between items-center mb-4">
        <a href="/" class="text-4xl font-bold text-center text-[#8d4f01] font-cinzel hover:text-[#b74f00] transition duration-200">
            Karma Path: Mahabharata Event Visualizer
        </a>
        <a href="/family-tree" 
           class="bg-white border border-[#b74f00] text-[#b74f00] hover:bg-[#fcf6e8] font-cinzel font-semibold py-2 px-6 rounded-lg transition duration-200 ease-in-out shadow-sm
                  focus:outline-none focus:ring-2 focus:ring-[#b74f00] focus:ring-offset-2 text-lg uppercase tracking-wide mt-4 sm:mt-0">
            Family Tree
        </a>
        </div>
    
        <p class="text-gray-700 text-center mb-8 text-lg">Unravel the tapestry of cause and consequence in the Great Epic.</p>

        <div class="mb-6 text-center bg-gray-50 p-4 rounded-lg shadow-inner border border-gray-100">
            <label class="text-xl font-semibold text-[#6a402a] mr-4 font-cinzel">Trace Type:</label>
            <input type="radio" id="traceCauses" name="traceType" value="causes" class="mr-1 h-5 w-5 text-[#b74f00] focus:ring-[#8d4f01] border-gray-300" checked>
            <label for="traceCauses" class="mr-6 text-lg text-gray-700">Causes (What led to...)</label>
            <input type="radio" id="traceConsequences" name="traceType" value="consequences" class="mr-1 h-5 w-5 text-[#b74f00] focus:ring-[#8d4f01] border-gray-300">
            <label for="traceConsequences" class="text-lg text-gray-700">Consequences (What happened after...)</label>
        </div>

        <div class="flex flex-col sm:flex-row gap-4 mb-8">
            <input type="text" id="questionInput" placeholder="e.g., What led to born of Ghatotkacha ?"
                   class="flex-grow p-4 border border-gray-300 rounded-lg text-lg
                          focus:ring-2 focus:ring-[#b74f00] focus:border-transparent outline-none
                          transition duration-150 ease-in-out text-gray-800 bg-gray-50 shadow-sm" autofocus>
            <button id="generateButton"
                    class="bg-[#b74f00] hover:bg-[#8d4f01] text-white font-cinzel font-semibold py-4 px-8 rounded-lg
                           transition duration-200 ease-in-out shadow-md hover:shadow-lg
                           focus:outline-none focus:ring-2 focus:ring-[#b74f00] focus:ring-offset-2
                           text-xl uppercase tracking-wide">
                Find Event
            </button>
        </div>

        <div id="resultArea" class="mt-8 min-h-[300px] relative">
            <div id="loadingIndicator" class="hidden absolute inset-0 bg-white bg-opacity-80 flex flex-col justify-center items-center rounded-lg z-10">
                <div class="loader"></div>
                <p class="text-gray-600 text-lg mt-3">Consulting the ancient texts...</p>
            </div>
            <div id="errorMessage" class="hidden p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg text-center font-medium shadow-md"></div>

            <div id="disambiguationArea" class="hidden bg-yellow-50 border border-yellow-300 rounded-lg p-6 shadow-md">
                <h3 class="text-2xl font-semibold text-center text-yellow-800 mb-5 font-cinzel">Did you mean one of these?</h3>
                <p class="text-center text-yellow-700 mb-5 text-lg">Your query matched multiple events. Please select the precise thread of karma:</p>
                <div id="choicesList" class="space-y-3">
                    </div>
            </div>

            <div id="flowchartContainer" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-6 mt-4 overflow-x-auto shadow-md">
                <h2 id="originalQuestion" class="text-lg font-medium text-center text-gray-500 mb-2"></h2>
                <h3 id="chartTitle" class="text-2xl font-semibold text-center text-[#6a402a] mb-5 font-cinzel"></h3>
                <div id="mermaidChart" class="mermaid bg-white p-4 rounded-lg shadow-inner border border-gray-100">
                    </div>
            </div>
        </div>
    </div>

    <script>
        // Initialize Mermaid with custom theme for better integration
        mermaid.initialize({
            startOnLoad: false,
            theme: 'base', // Using 'base' and applying custom styles via CSS classes
            securityLevel: 'loose',
            flowchart: {
                htmlLabels: true, // Allow HTML in labels for better styling
                curve: 'basis' // Smooth curves
            }
        });

        // Get references to UI elements
        const questionInput = document.getElementById('questionInput');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const disambiguationArea = document.getElementById('disambiguationArea');
        const choicesList = document.getElementById('choicesList');
        const flowchartContainer = document.getElementById('flowchartContainer');
        const mermaidChartDiv = document.getElementById('mermaidChart');
        const originalQuestionTitle = document.getElementById('originalQuestion');
        const chartTitle = document.getElementById('chartTitle');

        // Store current query context for disambiguation clicks
        let currentQuery = "";
        let currentTraceType = "causes";

        // --- REVISED: Initial Request to Find Matches ---
        async function findMatches() {
            currentQuery = questionInput.value.trim(); // Store query
            currentTraceType = document.querySelector('input[name="traceType"]:checked').value; // Store trace type

            if (!currentQuery) {
                showError("Please enter an event description to trace its path.");
                return;
            }

            hideError(); hideDisambiguation(); hideFlowchart(); showLoading();
            generateButton.disabled = true;
            loadingIndicator.querySelector('p').textContent = "Consulting the ancient texts for matches..."; // Update loading text

            try {
                // Send query to the new matching endpoint
                const response = await fetch('/find_event_matches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: currentQuery, trace_type: currentTraceType })
                });
                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'The threads of fate seem tangled. Unknown server error during matching.');
                    return;
                }

                // Check the status returned by the backend
                if (data.status === 'success') {
                    // Direct match found, display flowchart
                    renderFlowchart(data);
                } else if (data.status === 'disambiguation_required') {
                    // Multiple choices found, display them
                    displayChoices(data.choices);
                } else {
                    showError(data.error || 'An unexpected omen appeared. Unexpected response from server.');
                }

            } catch (error) {
                console.error("Error finding matches:", error);
                showError(`The connection to the past is weak. Failed to connect or process request: ${error.message}`);
            } finally {
                hideLoading(); generateButton.disabled = false;
            }
        }

        // --- NEW: Function to Display Choices ---
        function displayChoices(choices) {
            choicesList.innerHTML = ''; // Clear previous choices
            if (!choices || choices.length === 0) {
                showError("No threads of karma found, even for disambiguation. Try a different query.");
                return;
            }
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('choice-button');
                // Use dataset attributes to store info needed for the next step
                button.dataset.eventId = choice.id;
                button.dataset.eventLabel = choice.label;
                button.innerHTML = `<strong>[${choice.id}]</strong> ${choice.label} <i>(Match Score: ${choice.score})</i>`;
                // Add event listener to handle click
                button.addEventListener('click', handleChoiceClick);
                choicesList.appendChild(button);
            });
            showDisambiguation(); // Make the choices section visible
        }

        // --- NEW: Function to Handle Choice Click ---
        async function handleChoiceClick(event) {
            const button = event.currentTarget;
            const eventId = button.dataset.eventId;
            // const eventLabel = button.dataset.eventLabel; // Not strictly needed for backend

            hideDisambiguation(); showLoading();
            loadingIndicator.querySelector('p').textContent = "Weaving the Karma Path into a visual tale..."; // Update loading text

            try {
                // Send the CHOSEN event ID to the specific backend endpoint
                const endpoint = (currentTraceType === 'consequences') ? '/get_consequences_by_id' : '/get_flowchart_by_id';
                const response = await fetch(endpoint, { // Use new endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_id: eventId,
                        trace_type: currentTraceType,
                        user_question: currentQuery // Send original query for context
                        })
                });
                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'The loom of causality broke. Unknown server error generating flowchart by ID.');
                    return;
                }
                if (data.status === 'success') {
                    renderFlowchart(data);
                } else {
                    showError(data.error || 'The cosmic dance paused. Unexpected response from server after choosing ID.');
                }

            } catch (error) {
                console.error("Error generating flowchart by ID:", error);
                showError(`The threads are lost. Failed to connect or process request: ${error.message}`);
            } finally {
                hideLoading();
            }
        }


        // --- NEW: Function to Render the Final Flowchart ---
        async function renderFlowchart(data) {
            const titlePrefix = (data.trace_type === 'consequences') ? 'Consequences of' : 'What led to';
            originalQuestionTitle.textContent = `Your Query: "${data.user_question}" (Tracing ${data.trace_type})`;
            chartTitle.textContent = `Flowchart: ${titlePrefix} "${data.target_label}"?`;

            mermaidChartDiv.innerHTML = '';
            mermaidChartDiv.removeAttribute('data-processed');

            try {
                const { svg } = await mermaid.render('mermaid-graph-' + Date.now(), data.mermaid_code);
                mermaidChartDiv.innerHTML = svg;
                showFlowchart();
            } catch(renderError) {
                console.error("Mermaid rendering error:", renderError);
                // Attempt to show Mermaid's error message if available
                mermaidChartDiv.innerHTML = `<pre class="text-red-600 p-4 bg-red-50 rounded">Error rendering the Karma Path flowchart:\n${renderError.str || renderError.message}</pre>`;
                showFlowchart(); // Show the container even with error message
                // Don't call showError as it would hide the container
            }
        }


        // --- UI Helper Functions ---
        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }
        function showError(message) {
            errorMessage.textContent = message; errorMessage.classList.remove('hidden');
            hideFlowchart(); hideLoading(); hideDisambiguation(); // Hide everything else on error
        }
        function hideError() { errorMessage.classList.add('hidden'); }
        function showFlowchart() { flowchartContainer.classList.remove('hidden'); }
        function hideFlowchart() { flowchartContainer.classList.add('hidden'); }
        function showDisambiguation() { disambiguationArea.classList.remove('hidden'); }
        function hideDisambiguation() { disambiguationArea.classList.add('hidden'); }

        // --- Event Listeners ---
        // Button click initiates the *match finding* process
        generateButton.addEventListener('click', findMatches);
        // Enter key in input also initiates match finding
        questionInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { event.preventDefault(); findMatches(); }
        });

        // Update placeholder text and clear results area when radio button changes
        document.querySelectorAll('input[name="traceType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const placeholderText = (this.value === 'consequences') ? 'e.g., What happened after Arjuna pierced the fish eye?' : 'e.g., What led to born of Ghatotkacha ?';
                questionInput.placeholder = placeholderText;
                // Clear previous results when trace type changes
                hideError(); hideDisambiguation(); hideFlowchart();
                questionInput.value = ""; // Clear input for fresh query
            });
        });

    </script>
</body>
</html>