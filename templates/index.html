<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mahabharata Consequences Flowchart</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Mermaid JS -->
    <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
    <!-- Google Font -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Inter', sans-serif; }
        .loader {
            border: 4px solid #f3f3f3; border-top: 4px solid #4f46e5;
            border-radius: 50%; width: 30px; height: 30px;
            animation: spin 1s linear infinite; margin: 20px auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .mermaid { display: flex; justify-content: center; }
        .mermaid svg { max-width: 100%; height: auto; }
        /* Style for choice buttons */
        .choice-button {
            display: block; width: 100%; text-align: left;
            padding: 0.75rem 1rem; margin-bottom: 0.5rem;
            border: 1px solid #d1d5db; border-radius: 0.5rem;
            background-color: #f9fafb; color: #374151;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .choice-button:hover { background-color: #e5e7eb; border-color: #9ca3af; }
        .choice-button strong { color: #1f2937; }
    </style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen p-4 md:p-8">
    <div class="max-w-5xl mx-auto bg-white rounded-xl shadow-lg p-6 md:p-10">
        <h1 class="text-3xl font-bold text-center text-indigo-800 mb-4">Mahabharata Consequences Flowchart</h1>
        <p class="text-gray-600 text-center mb-8">Select trace type and ask about a specific event.</p>

        <!-- Trace Type Selection -->
        <div class="mb-6 text-center">
            <label class="text-lg font-semibold text-gray-700 mr-4">Trace Type:</label>
            <input type="radio" id="traceCauses" name="traceType" value="causes" class="mr-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300" checked>
            <label for="traceCauses" class="mr-4 text-lg text-gray-600">Causes (What led to...)</label>
            <input type="radio" id="traceConsequences" name="traceType" value="consequences" class="mr-1 h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300">
            <label for="traceConsequences" class="text-lg text-gray-600">Consequences (What happened after...)</label>
        </div>

        <!-- Input Form -->
        <div class="flex flex-col sm:flex-row gap-3 mb-8">
            <input type="text" id="questionInput" placeholder="e.g., What led to the game of dice?" class="flex-grow p-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none transition duration-150 ease-in-out text-lg" autofocus>
            <button id="generateButton" class="bg-indigo-600 hover:bg-indigo-700 text-white font-semibold py-3 px-6 rounded-lg transition duration-150 ease-in-out shadow focus:outline-none focus:ring-2 focus:ring-indigo-500 focus:ring-offset-2 text-lg">
                Find Event
            </button>
        </div>

        <!-- Result/Loading/Error/Disambiguation Area -->
        <div id="resultArea" class="mt-8 min-h-[300px]">
            <div id="loadingIndicator" class="hidden text-center">
                 <div class="loader"></div>
                 <p class="text-gray-500">Processing...</p> <!-- Generic message -->
            </div>
            <div id="errorMessage" class="hidden p-4 bg-red-100 text-red-700 border border-red-300 rounded-lg text-center font-medium"></div>

            <!-- NEW: Disambiguation Area -->
            <div id="disambiguationArea" class="hidden bg-yellow-50 border border-yellow-200 rounded-lg p-4">
                <h3 class="text-xl font-semibold text-center text-yellow-800 mb-4">Did you mean one of these?</h3>
                <p class="text-center text-yellow-700 mb-4">Multiple events matched your query. Please select the correct one:</p>
                <div id="choicesList">
                    <!-- Choice buttons will be added here by JavaScript -->
                </div>
            </div>

            <!-- Flowchart Area -->
            <div id="flowchartContainer" class="hidden bg-gray-50 border border-gray-200 rounded-lg p-4 mt-4 overflow-x-auto">
                 <h2 id="originalQuestion" class="text-lg font-medium text-center text-gray-500 mb-2"></h2>
                 <h3 id="chartTitle" class="text-xl font-semibold text-center text-gray-800 mb-4"></h3>
                 <div id="mermaidChart" class="mermaid">
                    <!-- Mermaid chart rendered here -->
                </div>
            </div>
        </div>
    </div>

    <script>
        mermaid.initialize({ startOnLoad: false, theme: 'base', securityLevel: 'loose' });

        // Get references to UI elements
        const questionInput = document.getElementById('questionInput');
        const generateButton = document.getElementById('generateButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const errorMessage = document.getElementById('errorMessage');
        const disambiguationArea = document.getElementById('disambiguationArea');
        const choicesList = document.getElementById('choicesList');
        const flowchartContainer = document.getElementById('flowchartContainer');
        const mermaidChartDiv = document.getElementById('mermaidChart');
        const originalQuestionTitle = document.getElementById('originalQuestion');
        const chartTitle = document.getElementById('chartTitle');

        // Store current query context for disambiguation clicks
        let currentQuery = "";
        let currentTraceType = "causes";

        // --- REVISED: Initial Request to Find Matches ---
        async function findMatches() {
            currentQuery = questionInput.value.trim(); // Store query
            currentTraceType = document.querySelector('input[name="traceType"]:checked').value; // Store trace type

            if (!currentQuery) {
                showError("Please enter an event description.");
                return;
            }

            hideError(); hideDisambiguation(); hideFlowchart(); showLoading();
            generateButton.disabled = true;
            loadingIndicator.querySelector('p').textContent = "Finding matching events..."; // Update loading text

            try {
                // Send query to the new matching endpoint
                const response = await fetch('/find_event_matches', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ question: currentQuery, trace_type: currentTraceType })
                });
                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'Unknown server error during matching.');
                    return;
                }

                // Check the status returned by the backend
                if (data.status === 'success') {
                    // Direct match found, display flowchart
                    renderFlowchart(data);
                } else if (data.status === 'disambiguation_required') {
                    // Multiple choices found, display them
                    displayChoices(data.choices);
                } else {
                    showError(data.error || 'Unexpected response from server.');
                }

            } catch (error) {
                console.error("Error finding matches:", error);
                showError(`Failed to connect or process request: ${error.message}`);
            } finally {
                hideLoading(); generateButton.disabled = false;
            }
        }

        // --- NEW: Function to Display Choices ---
        function displayChoices(choices) {
            choicesList.innerHTML = ''; // Clear previous choices
            if (!choices || choices.length === 0) {
                showError("No matches found, even for disambiguation.");
                return;
            }
            choices.forEach(choice => {
                const button = document.createElement('button');
                button.classList.add('choice-button');
                // Use dataset attributes to store info needed for the next step
                button.dataset.eventId = choice.id;
                button.dataset.eventLabel = choice.label;
                button.innerHTML = `<strong>[${choice.id}]</strong> ${choice.label} <i>(Score: ${choice.score})</i>`;
                // Add event listener to handle click
                button.addEventListener('click', handleChoiceClick);
                choicesList.appendChild(button);
            });
            showDisambiguation(); // Make the choices section visible
        }

        // --- NEW: Function to Handle Choice Click ---
        async function handleChoiceClick(event) {
            const button = event.currentTarget;
            const eventId = button.dataset.eventId;
            // const eventLabel = button.dataset.eventLabel; // Not strictly needed for backend

            hideDisambiguation(); showLoading();
            loadingIndicator.querySelector('p').textContent = "Generating flowchart..."; // Update loading text

            try {
                 // Send the CHOSEN event ID to the specific backend endpoint
                const endpoint = (currentTraceType === 'consequences') ? '/get_consequences_by_id' : '/get_flowchart_by_id';
                const response = await fetch(endpoint, { // Use new endpoint
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        event_id: eventId,
                        trace_type: currentTraceType,
                        user_question: currentQuery // Send original query for context
                        })
                });
                const data = await response.json();

                if (!response.ok) {
                    showError(data.error || 'Unknown server error generating flowchart by ID.');
                    return;
                }
                if (data.status === 'success') {
                    renderFlowchart(data);
                } else {
                     showError(data.error || 'Unexpected response from server after choosing ID.');
                }

            } catch (error) {
                console.error("Error generating flowchart by ID:", error);
                showError(`Failed to connect or process request: ${error.message}`);
            } finally {
                 hideLoading();
            }

        }


        // --- NEW: Function to Render the Final Flowchart ---
        async function renderFlowchart(data) {
             const titlePrefix = (data.trace_type === 'consequences') ? 'Consequences of' : 'What led to';
             originalQuestionTitle.textContent = `Your Query: "${data.user_question}" (Tracing ${data.trace_type})`;
             chartTitle.textContent = `Flowchart: ${titlePrefix} "${data.target_label}"?`;

             mermaidChartDiv.innerHTML = '';
             mermaidChartDiv.removeAttribute('data-processed');

             try {
                  const { svg } = await mermaid.render('mermaid-graph-' + Date.now(), data.mermaid_code);
                  mermaidChartDiv.innerHTML = svg;
                  showFlowchart();
             } catch(renderError) {
                  console.error("Mermaid rendering error:", renderError);
                  // Attempt to show Mermaid's error message if available
                  mermaidChartDiv.innerHTML = `<pre class="text-red-600 p-4 bg-red-50 rounded">Error rendering flowchart:\n${renderError.str || renderError.message}</pre>`;
                  showFlowchart(); // Show the container even with error message
                  // Don't call showError as it would hide the container
             }
        }


        // --- UI Helper Functions ---
        function showLoading() { loadingIndicator.classList.remove('hidden'); }
        function hideLoading() { loadingIndicator.classList.add('hidden'); }
        function showError(message) {
            errorMessage.textContent = message; errorMessage.classList.remove('hidden');
            hideFlowchart(); hideLoading(); hideDisambiguation(); // Hide everything else on error
        }
        function hideError() { errorMessage.classList.add('hidden'); }
        function showFlowchart() { flowchartContainer.classList.remove('hidden'); }
        function hideFlowchart() { flowchartContainer.classList.add('hidden'); }
        function showDisambiguation() { disambiguationArea.classList.remove('hidden'); }
        function hideDisambiguation() { disambiguationArea.classList.add('hidden'); }

        // --- Event Listeners ---
        // Button click initiates the *match finding* process
        generateButton.addEventListener('click', findMatches);
        // Enter key in input also initiates match finding
        questionInput.addEventListener('keypress', function(event) {
            if (event.key === 'Enter') { event.preventDefault(); findMatches(); }
        });

        // Update placeholder text when radio button changes
        document.querySelectorAll('input[name="traceType"]').forEach(radio => {
            radio.addEventListener('change', function() {
                const placeholderText = (this.value === 'consequences') ? 'e.g., Consequences of the game of dice' : 'e.g., What led to the game of dice?';
                questionInput.placeholder = placeholderText;
            });
        });

    </script>
</body>
</html>